name: Validated Stealth DB Sync

on:
  workflow_dispatch:
    inputs:
      movie_url:
        description: 'Direct Link of the Movie'
        required: true
      movie_id:
        description: 'Target Movie ID (e.g. 60002)'
        required: true
      mask_extension:
        description: 'Mask Extension (.dat, .xapk, .log)'
        required: true
        default: '.dat'

jobs:
  secure-process:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. ‡§ú‡§∞‡•Ç‡§∞‡•Ä ‡§ü‡•Ç‡§≤‡•ç‡§∏ ‡§∏‡•á‡§ü‡§Ö‡§™
      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg mysql-client
          echo "‚úÖ Tools Installed"

      # 2. ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°
      - name: Download Movie
        run: |
          curl -L "${{ github.event.inputs.movie_url }}" -o "check_video.mp4"
          echo "‚úÖ Download Finished"

      # 3. üî• CRITICAL: ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§ï‡§∞‡§™‡•ç‡§∂‡§® ‡§ö‡•á‡§ï (FFmpeg Logic)
      - name: Verify Video Integrity
        id: verify
        run: |
          echo "‚è≥ Checking for corruption..."
          # ffprobe ‡§∏‡•á ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á ‡§ï‡§ø ‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§Æ‡•ç‡§∏ ‡§∞‡•Ä‡§°‡•á‡§¨‡§≤ ‡§π‡•à‡§Ç ‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç
          if ! ffprobe -v error -show_format -show_streams "check_video.mp4" ; then
            echo "üö® ERROR: Video file is corrupt or invalid!"
            exit 1
          fi
          
          # ‡§è‡§ï ‡§õ‡•ã‡§ü‡§æ ‡§∏‡§æ ‡§°‡§ø‡§ï‡•ã‡§° ‡§ü‡•á‡§∏‡•ç‡§ü (‡§™‡§π‡§≤‡•á 5 ‡§∏‡•á‡§ï‡§Ç‡§°) ‡§§‡§æ‡§ï‡§ø ‡§™‡§ï‡•ç‡§ï‡§æ ‡§π‡•ã ‡§∏‡§ï‡•á ‡§ï‡§ø ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§ö‡§≤‡§§‡§æ ‡§π‡•à
          if ! ffmpeg -v error -i "check_video.mp4" -t 5 -f null - ; then
            echo "üö® ERROR: Video stream is unplayable!"
            exit 1
          fi
          echo "‚úÖ Video is healthy!"

      # 4. ‡§ï‡•ç‡§µ‡§æ‡§≤‡§ø‡§ü‡•Ä ‡§°‡§ø‡§ü‡•á‡§ï‡•ç‡§∂‡§® (‡§Ö‡§ó‡§∞ ‡§µ‡•á‡§∞‡§ø‡§´‡§ø‡§ï‡•á‡§∂‡§® ‡§™‡§æ‡§∏ ‡§π‡•Å‡§Ü ‡§§‡§≠‡•Ä ‡§Ø‡§π‡§æ‡§Å ‡§™‡§π‡•Å‡§Å‡§ö‡•á‡§ó‡§æ)
      - name: Detect Quality
        id: detect
        run: |
          HEIGHT=$(ffprobe -v error -select_streams v:0 -show_entries stream=height -of csv=p=0 "check_video.mp4")
          if [ "$HEIGHT" -ge 2160 ]; then LABEL="4K";
          elif [ "$HEIGHT" -ge 1080 ]; then LABEL="1080p";
          elif [ "$HEIGHT" -ge 720 ]; then LABEL="720p";
          else LABEL="480p"; fi
          echo "quality_label=$LABEL" >> $GITHUB_OUTPUT
          echo "‚úÖ Quality: $LABEL"

      # 5. ‡§≠‡•á‡§∑ ‡§¨‡§¶‡§≤‡§®‡§æ (Masking)
      - name: Masking
        id: mask
        run: |
          FILENAME="m_id_${{ github.event.inputs.movie_id }}_${{ steps.detect.outputs.quality_label }}${{ github.event.inputs.mask_extension }}"
          mv "check_video.mp4" "$FILENAME"
          echo "final_file=$FILENAME" >> $GITHUB_OUTPUT

      # 6. GitHub Release ‡§¨‡§®‡§æ‡§®‡§æ
      - name: Create Release
        id: release
        run: |
          TAG="rel_${{ github.event.inputs.movie_id }}_$(date +'%Y%m%d%H%M%S')"
          gh release create "$TAG" --title "ID: ${{ github.event.inputs.movie_id }}" --notes "Auto Upload" "./${{ steps.mask.outputs.final_file }}"
          
          REPO="${{ github.repository }}"
          ASSET_URL="https://github.com/$REPO/releases/download/$TAG/${{ steps.mask.outputs.final_file }}"
          echo "final_link=$ASSET_URL" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 7. TiDB ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Ö‡§™‡§°‡•á‡§ü (DB Sync)
      - name: DB Update
        run: |
          DB_HOST="db.fr-pari1.bengt.wasmernet.com"
          DB_PORT="10272"
          DB_USER="c08b610b7a5780004be5223e9614"
          DB_PASS="0691c08b-610b-7bfa-8000-977f874d9bfb"
          DB_NAME="mcinema"
          
          M_ID="${{ github.event.inputs.movie_id }}"
          S_URL="${{ steps.release.outputs.final_link }}"
          Q_LABEL="${{ steps.detect.outputs.quality_label }}"
          
          # ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•á‡§Ç ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä
          mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" -D "$DB_NAME" -e "INSERT INTO streaming_links (movie_id, stream_url, quality_label) VALUES ('$M_ID', '$S_URL', '$Q_LABEL');"
          
          echo "üöÄ ‡§¨‡§æ‡§¶‡§≤ ‡§≠‡§æ‡§à, ‡§∏‡§¨ ‡§∏‡•á‡§ü ‡§π‡•à! ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§è‡§ï‡§¶‡§Æ ‡§Ö‡§∏‡§≤‡•Ä ‡§•‡§æ ‡§î‡§∞ DB ‡§Æ‡•á‡§Ç ‡§™‡§π‡•Å‡§Å‡§ö ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§"
