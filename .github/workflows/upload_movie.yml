name: Ultimate Stealth Engine (Verified & Optimized) ðŸš€ðŸŽ¬

on:
  workflow_dispatch:
    inputs:
      movie_url:
        description: 'Direct Link of the Movie'
        required: true
      movie_id:
        description: 'Target Movie ID (e.g. 60002)'
        required: true
      mask_extension:
        description: 'Mask Extension'
        required: true
        default: '.dat'

jobs:
  stealth-operation:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. à¤œà¤°à¥‚à¤°à¥€ à¤Ÿà¥‚à¤²à¥à¤¸ (FFmpeg + MySQL)
      - name: Install War Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg mysql-client
          echo "âœ… Tools Ready"

      # 2. à¤«à¤¾à¤‡à¤² à¤¡à¤¾à¤‰à¤¨à¤²à¥‹à¤¡ à¤•à¤°à¤¨à¤¾
      - name: Fetch Target Data
        run: |
          echo "â³ Downloading Source Movie..."
          curl -L "${{ github.event.inputs.movie_url }}" -o "raw_source.mp4"
          echo "âœ… Download Complete"

      # 3. ðŸ”¥ STRICT CORRUPTION VERIFICATION (à¤…à¤¸à¤²à¥€ à¤šà¥‡à¤•à¤¿à¤‚à¤—)
      - name: Verify Data Integrity
        run: |
          echo "â³ Scanning for corruption (Level 1: Format Check)..."
          # ffprobe à¤šà¥‡à¤• à¤•à¤°à¥‡à¤—à¤¾ à¤•à¤¿ à¤«à¤¾à¤‡à¤² à¤•à¤¾ à¤¹à¥‡à¤¡à¤° à¤”à¤° à¤¸à¥à¤Ÿà¥à¤°à¥€à¤®à¥à¤¸ à¤°à¥€à¤¡à¥‡à¤¬à¤² à¤¹à¥ˆà¤‚ à¤¯à¤¾ à¤¨à¤¹à¥€à¤‚
          if ! ffprobe -v error -show_format -show_streams "raw_source.mp4" ; then
            echo "ðŸš¨ ERROR: File Header Corrupt! Operation Aborted."
            exit 1
          fi

          echo "â³ Scanning for corruption (Level 2: Stream Decode Test)..."
          # ffmpeg à¤¸à¥‡ à¤ªà¤¹à¤²à¥‡ 5 à¤¸à¥‡à¤•à¤‚à¤¡ à¤•à¤¾ à¤¡à¥‡à¤Ÿà¤¾ 'null' à¤¡à¤¿à¤µà¤¾à¤‡à¤¸ à¤ªà¤° à¤ªà¥à¤²à¥‡ à¤•à¤°à¤•à¥‡ à¤¦à¥‡à¤–à¥‡à¤‚à¤—à¥‡ 
          # à¤…à¤—à¤° à¤¸à¥à¤Ÿà¥à¤°à¥€à¤® à¤®à¥‡à¤‚ à¤•à¥‹à¤ˆ à¤à¤°à¤° à¤¹à¥‹à¤—à¤¾ à¤¤à¥‹ à¤¯à¥‡ à¤«à¥‡à¤² à¤¹à¥‹ à¤œà¤¾à¤à¤—à¤¾
          if ! ffmpeg -v error -i "raw_source.mp4" -t 5 -f null - ; then
            echo "ðŸš¨ ERROR: Video Stream is Unplayable/Corrupt! Aborting Mission."
            exit 1
          fi
          echo "âœ… Video is 100% Healthy! Proceeding to Transcode..."

      # 4. à¤“à¤°à¤¿à¤œà¤¿à¤¨à¤² à¤•à¥à¤µà¤¾à¤²à¤¿à¤Ÿà¥€ à¤¡à¤¿à¤Ÿà¥‡à¤•à¥à¤¶à¤¨
      - name: Detect Intelligence
        id: detect
        run: |
          HEIGHT=$(ffprobe -v error -select_streams v:0 -show_entries stream=height -of csv=p=0 "raw_source.mp4")
          if [ "$HEIGHT" -ge 2160 ]; then LABEL="4K";
          elif [ "$HEIGHT" -ge 1080 ]; then LABEL="1080p";
          elif [ "$HEIGHT" -ge 720 ]; then LABEL="720p";
          else LABEL="SD"; fi
          echo "orig_label=$LABEL" >> $GITHUB_OUTPUT

      # 5. ðŸ”¥ HIGH-OPT TRANSCODING (Video: Optimized | Audio: Original Copy)
      - name: Transcode Secret Versions
        run: |
          echo "â³ Creating 360p (Optimized Video | Original Audio)..."
          # -preset slow (Better compression) | -c:a copy (Original Audio)
          ffmpeg -i "raw_source.mp4" -map 0:v:0 -map 0:a:0 -c:v libx264 -crf 28 -preset slow \
          -vf "scale=-2:360" -maxrate 600k -bufsize 1.2M \
          -c:a copy -sn -dn -map_metadata -1 "v_360p.mp4"
          
          echo "â³ Creating 240p (Optimized Video | Original Audio)..."
          ffmpeg -i "raw_source.mp4" -map 0:v:0 -map 0:a:0 -c:v libx264 -crf 30 -preset slow \
          -vf "scale=-2:240" -maxrate 400k -bufsize 800k \
          -c:a copy -sn -dn -map_metadata -1 "v_240p.mp4"
          
          echo "â³ Cleaning Original (Removing Junk Data)..."
          ffmpeg -i "raw_source.mp4" -map 0:v:0 -map 0:a:0 -c copy -sn -dn -map_metadata -1 "v_orig.mp4"
          echo "âœ… All Operation Success!"

      # 6. ðŸŽ­ SECRET PROJECT NAMING
      - name: Mask Assets
        id: mask
        run: |
          ID="${{ github.event.inputs.movie_id }}"
          EXT="${{ github.event.inputs.mask_extension }}"
          LBL="${{ steps.detect.outputs.orig_label }}"
          
          NAME_ORIG="SEC_DATA_${ID}_${LBL}${EXT}"
          NAME_360="SEC_DATA_${ID}_360p${EXT}"
          NAME_240="SEC_DATA_${ID}_240p${EXT}"
          
          mv "v_orig.mp4" "$NAME_ORIG"
          mv "v_360p.mp4" "$NAME_360"
          mv "v_240p.mp4" "$NAME_240"
          
          echo "f_orig=$NAME_ORIG" >> $GITHUB_OUTPUT
          echo "f_360=$NAME_360" >> $GITHUB_OUTPUT
          echo "f_240=$NAME_240" >> $GITHUB_OUTPUT

      # 7. UPLOAD TO GITHUB RELEASE
      - name: Deploy to Release
        id: release
        run: |
          TAG="PROJ_REL_${{ github.event.inputs.movie_id }}_$(date +'%Y%m%d%H%M%S')"
          gh release create "$TAG" \
            --title "INTERNAL_DATA_ID_${{ github.event.inputs.movie_id }}" \
            --notes "Project Encrypted | Corruption Verified | Original Audio" \
            "./${{ steps.mask.outputs.f_orig }}" \
            "./${{ steps.mask.outputs.f_360 }}" \
            "./${{ steps.mask.outputs.f_240 }}"
          
          REPO="${{ github.repository }}"
          BASE="https://github.com/$REPO/releases/download/$TAG"
          echo "u_orig=$BASE/${{ steps.mask.outputs.f_orig }}" >> $GITHUB_OUTPUT
          echo "u_360=$BASE/${{ steps.mask.outputs.f_360 }}" >> $GITHUB_OUTPUT
          echo "u_240=$BASE/${{ steps.mask.outputs.f_240 }}" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 8. ðŸš€ DB SYNC (TiDB)
      - name: Sync with TiDB
        run: |
          DB_HOST="db.fr-pari1.bengt.wasmernet.com"
          DB_PORT="10272"
          DB_USER="c08b610b7a5780004be5223e9614"
          DB_PASS="0691c08b-610b-7bfa-8000-977f874d9bfb"
          DB_NAME="mcinema"
          MID="${{ github.event.inputs.movie_id }}"
          
          mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" -D "$DB_NAME" <<EOF
          INSERT INTO streaming_links (movie_id, stream_url, quality_label) VALUES 
          ('$MID', '${{ steps.release.outputs.u_orig }}', '${{ steps.detect.outputs.orig_label }}'),
          ('$MID', '${{ steps.release.outputs.u_360 }}', '360p'),
          ('$MID', '${{ steps.release.outputs.u_240 }}', '240p');
          EOF
          echo "âœ… à¤®à¤¿à¤¶à¤¨ à¤•à¤¾à¤®à¤¯à¤¾à¤¬! à¤¡à¥‡à¤Ÿà¤¾à¤¬à¥‡à¤¸ à¤…à¤ªà¤¡à¥‡à¤Ÿ à¤¹à¥‹ à¤—à¤¯à¤¾ à¤¹à¥ˆà¥¤ ðŸš€ðŸ¤¡"
