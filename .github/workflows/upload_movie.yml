name: Ultimate Stealth Engine (Original Audio) ðŸš€ðŸ”Š

on:
  workflow_dispatch:
    inputs:
      movie_url:
        description: 'Direct Link of the Movie'
        required: true
      movie_id:
        description: 'Target Movie ID (e.g. 60002)'
        required: true
      mask_extension:
        description: 'Mask Extension'
        required: true
        default: '.dat'

jobs:
  stealth-operation:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. à¤Ÿà¥‚à¤²à¥à¤¸ à¤¸à¥‡à¤Ÿà¤…à¤ª
      - name: Install War Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg mysql-client
          echo "âœ… Tools Ready"

      # 2. à¤¡à¤¾à¤‰à¤¨à¤²à¥‹à¤¡à¤¿à¤‚à¤—
      - name: Fetch Target Data
        run: |
          echo "â³ Downloading Source..."
          curl -L "${{ github.event.inputs.movie_url }}" -o "raw_source.mp4"
          echo "âœ… Download Complete"

      # 3. à¤•à¤°à¤ªà¥à¤¶à¤¨ à¤šà¥‡à¤• (Integrity Verification)
      - name: Verify Data Integrity
        run: |
          echo "â³ Scanning for corruption..."
          if ! ffprobe -v error -show_format -show_streams "raw_source.mp4" ; then
            echo "ðŸš¨ ERROR: File is Corrupt! Aborting Mission."
            exit 1
          fi
          echo "âœ… Data Integrity Confirmed!"

      # 4. à¤•à¥à¤µà¤¾à¤²à¤¿à¤Ÿà¥€ à¤¡à¤¿à¤Ÿà¥‡à¤•à¥à¤¶à¤¨
      - name: Detect Intelligence
        id: detect
        run: |
          HEIGHT=$(ffprobe -v error -select_streams v:0 -show_entries stream=height -of csv=p=0 "raw_source.mp4")
          if [ "$HEIGHT" -ge 2160 ]; then LABEL="4K";
          elif [ "$HEIGHT" -ge 1080 ]; then LABEL="1080p";
          elif [ "$HEIGHT" -ge 720 ]; then LABEL="720p";
          else LABEL="SD"; fi
          echo "orig_label=$LABEL" >> $GITHUB_OUTPUT

      # 5. ðŸ”¥ SMART TRANSCODING (Original Audio - No Compression)
      - name: Transcode Secret Versions
        run: |
          echo "â³ Processing 360p (Video Compressed | Audio Original)..."
          # -c:a copy -> Ye hai jaadu! Audio ko touch nahi karega, seedha copy karega.
          # -map 0:v:0 -map 0:a:0 -> Sirf pehla video aur pehla audio (Hindi) lega.
          ffmpeg -i "raw_source.mp4" -map 0:v:0 -map 0:a:0 -c:v libx264 -crf 28 -preset slow \
          -vf "scale=-2:360" -maxrate 600k -bufsize 1.2M \
          -c:a copy -sn -dn -map_metadata -1 "v_360p.mp4"
          
          echo "â³ Processing 240p (Video Super Compressed | Audio Original)..."
          ffmpeg -i "raw_source.mp4" -map 0:v:0 -map 0:a:0 -c:v libx264 -crf 30 -preset slow \
          -vf "scale=-2:240" -maxrate 400k -bufsize 800k \
          -c:a copy -sn -dn -map_metadata -1 "v_240p.mp4"
          
          echo "â³ Cleaning Original (Removing Subtitles/Tags)..."
          ffmpeg -i "raw_source.mp4" -map 0:v:0 -map 0:a:0 -c copy -sn -dn -map_metadata -1 "v_orig.mp4"
          echo "âœ… Processing Complete!"

      # 6. ðŸŽ­ SECRET NAMING (Masking)
      - name: Mask Assets
        id: mask
        run: |
          ID="${{ github.event.inputs.movie_id }}"
          EXT="${{ github.event.inputs.mask_extension }}"
          LBL="${{ steps.detect.outputs.orig_label }}"
          
          NAME_ORIG="SEC_DATA_${ID}_${LBL}${EXT}"
          NAME_360="SEC_DATA_${ID}_360p${EXT}"
          NAME_240="SEC_DATA_${ID}_240p${EXT}"
          
          mv "v_orig.mp4" "$NAME_ORIG"
          mv "v_360p.mp4" "$NAME_360"
          mv "v_240p.mp4" "$NAME_240"
          
          echo "f_orig=$NAME_ORIG" >> $GITHUB_OUTPUT
          echo "f_360=$NAME_360" >> $GITHUB_OUTPUT
          echo "f_240=$NAME_240" >> $GITHUB_OUTPUT

      # 7. UPLOAD TO GITHUB RELEASE
      - name: Deploy to Release
        id: release
        run: |
          TAG="PROJ_REL_${{ github.event.inputs.movie_id }}_$(date +'%Y%m%d%H%M%S')"
          gh release create "$TAG" \
            --title "INTERNAL_DATA_ID_${{ github.event.inputs.movie_id }}" \
            --notes "Original Audio Enabled" \
            "./${{ steps.mask.outputs.f_orig }}" \
            "./${{ steps.mask.outputs.f_360 }}" \
            "./${{ steps.mask.outputs.f_240 }}"
          
          REPO="${{ github.repository }}"
          BASE="https://github.com/$REPO/releases/download/$TAG"
          echo "u_orig=$BASE/${{ steps.mask.outputs.f_orig }}" >> $GITHUB_OUTPUT
          echo "u_360=$BASE/${{ steps.mask.outputs.f_360 }}" >> $GITHUB_OUTPUT
          echo "u_240=$BASE/${{ steps.mask.outputs.f_240 }}" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 8. ðŸš€ DB SYNC
      - name: Sync with TiDB
        run: |
          DB_HOST="db.fr-pari1.bengt.wasmernet.com"
          DB_PORT="10272"
          DB_USER="c08b610b7a5780004be5223e9614"
          DB_PASS="0691c08b-610b-7bfa-8000-977f874d9bfb"
          DB_NAME="mcinema"
          MID="${{ github.event.inputs.movie_id }}"
          
          mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" -D "$DB_NAME" <<EOF
          INSERT INTO streaming_links (movie_id, stream_url, quality_label) VALUES 
          ('$MID', '${{ steps.release.outputs.u_orig }}', '${{ steps.detect.outputs.orig_label }}'),
          ('$MID', '${{ steps.release.outputs.u_360 }}', '360p'),
          ('$MID', '${{ steps.release.outputs.u_240 }}', '240p');
          EOF
          echo "âœ… à¤®à¤¿à¤¶à¤¨ à¤•à¤¾à¤®à¤¯à¤¾à¤¬! à¤‘à¤¡à¤¿à¤¯à¥‹ à¤à¤•à¤¦à¤® à¤•à¥œà¤• à¤°à¤¹à¥‡à¤—à¤¾à¥¤ ðŸš€ðŸ¤¡"
