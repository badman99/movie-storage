name: Stealth Movie Sync (FFmpeg + DB)

on:
  workflow_dispatch:
    inputs:
      movie_url:
        description: 'Direct Link of the Movie'
        required: true
      movie_id:
        description: 'Target Movie ID (e.g. 60002)'
        required: true
      mask_extension:
        description: 'Mask Extension (.dat, .xapk, .log)'
        required: true
        default: '.dat'

jobs:
  process-and-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. ‡§ú‡§∞‡•Ç‡§∞‡•Ä ‡§î‡§ú‡§æ‡§∞ (Tools) ‡§∏‡•á‡§ü‡§Ö‡§™ ‡§ï‡§∞‡§®‡§æ
      - name: Install Tools (FFmpeg & MySQL)
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg mysql-client
          echo "‚úÖ Tools Ready!"

      # 2. ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§ï‡•ã ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§™‡§∞ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡§æ
      - name: Download Movie
        run: |
          curl -L "${{ github.event.inputs.movie_url }}" -o "video_raw.mp4"
          echo "‚úÖ Download Complete"

      # 3. üî• FFmpeg ‡§∏‡•á ‡§ï‡§∞‡§™‡•ç‡§∂‡§® ‡§ö‡•á‡§ï ‡§ï‡§∞‡§®‡§æ (‡§ñ‡§∞‡§æ‡§¨ ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§Ø‡§π‡•Ä‡§Ç ‡§∞‡•Å‡§ï ‡§ú‡§æ‡§è‡§ó‡§æ)
      - name: Verify Video Integrity
        id: verify
        run: |
          echo "‚è≥ Checking video health..."
          if ! ffprobe -v error -show_format -show_streams "video_raw.mp4" ; then
            echo "üö® Error: Video file is corrupt!"
            exit 1
          fi
          # 5 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§ï‡§æ ‡§™‡•ç‡§≤‡•á‡§¨‡•à‡§ï ‡§ü‡•á‡§∏‡•ç‡§ü
          if ! ffmpeg -v error -i "video_raw.mp4" -t 5 -f null - ; then
            echo "üö® Error: Video stream is unplayable!"
            exit 1
          fi
          echo "‚úÖ Video is Healthy"

      # 4. FFmpeg ‡§∏‡•á ‡§Ö‡§∏‡§≤‡•Ä ‡§ï‡•ç‡§µ‡§æ‡§≤‡§ø‡§ü‡•Ä ‡§ï‡§æ ‡§™‡§§‡§æ ‡§≤‡§ó‡§æ‡§®‡§æ
      - name: Detect Quality (Resolution)
        id: detect
        run: |
          HEIGHT=$(ffprobe -v error -select_streams v:0 -show_entries stream=height -of csv=p=0 "video_raw.mp4")
          if [ "$HEIGHT" -ge 2160 ]; then LABEL="4K";
          elif [ "$HEIGHT" -ge 1080 ]; then LABEL="1080p";
          elif [ "$HEIGHT" -ge 720 ]; then LABEL="720p";
          else LABEL="480p"; fi
          echo "quality_label=$LABEL" >> $GITHUB_OUTPUT
          echo "‚úÖ Detected: $LABEL"

      # 5. ‡§≠‡•á‡§∑ ‡§¨‡§¶‡§≤‡§®‡§æ (Masking & Renaming)
      - name: Mask Filename
        id: mask
        run: |
          # Example: m_id_60002_1080p.dat
          FINAL_NAME="m_id_${{ github.event.inputs.movie_id }}_${{ steps.detect.outputs.quality_label }}${{ github.event.inputs.mask_extension }}"
          mv "video_raw.mp4" "$FINAL_NAME"
          echo "final_filename=$FINAL_NAME" >> $GITHUB_OUTPUT
          echo "‚úÖ Masked Name: $FINAL_NAME"

      # 6. GitHub Release ‡§¨‡§®‡§æ‡§®‡§æ ‡§î‡§∞ ‡§°‡§æ‡§Ø‡§∞‡•á‡§ï‡•ç‡§ü ‡§≤‡§ø‡§Ç‡§ï ‡§ú‡•á‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡§®‡§æ
      - name: Create Stealth Release
        id: release
        run: |
          TAG="rel_${{ github.event.inputs.movie_id }}_$(date +'%Y%m%d%H%M%S')"
          # Release ‡§¨‡§®‡§æ‡§®‡§æ
          gh release create "$TAG" \
            --title "ID: ${{ github.event.inputs.movie_id }} Update" \
            --notes "Auto Sync" \
            "./${{ steps.mask.outputs.final_filename }}"
          
          # Direct Asset URL ‡§¨‡§®‡§æ‡§®‡§æ
          REPO="${{ github.repository }}"
          ASSET_URL="https://github.com/$REPO/releases/download/$TAG/${{ steps.mask.outputs.final_filename }}"
          echo "asset_url=$ASSET_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Asset URL: $ASSET_URL"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 7. üöÄ ‡§∏‡•Ä‡§ß‡§æ TiDB ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•á‡§Ç ‡§Æ‡§æ‡§≤ ‡§≠‡§∞‡§®‡§æ (Table check ‡§ï‡•á ‡§∏‡§æ‡§•)
      - name: Sync to Database (TiDB)
        run: |
          # ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§ï‡•ç‡§∞‡•á‡§°‡•á‡§Ç‡§∂‡§ø‡§Ø‡§≤‡•ç‡§∏ (Hardcoded as per your request)
          DB_HOST="db.fr-pari1.bengt.wasmernet.com"
          DB_PORT="10272"
          DB_USER="c08b610b7a5780004be5223e9614"
          DB_PASS="0691c08b-610b-7bfa-8000-977f874d9bfb"
          DB_NAME="mcinema"
          
          M_ID="${{ github.event.inputs.movie_id }}"
          S_URL="${{ steps.release.outputs.asset_url }}"
          Q_LABEL="${{ steps.detect.outputs.quality_label }}"

          echo "‚è≥ DB Syncing..."

          # SQL Execution: Table Create + Insert Data
          mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" -D "$DB_NAME" <<EOF
          CREATE TABLE IF NOT EXISTS streaming_links (
            id int AUTO_INCREMENT PRIMARY KEY,
            movie_id int NOT NULL,
            stream_url text NOT NULL,
            quality_label varchar(50) NOT NULL,
            KEY movie_id (movie_id)
          ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

          INSERT INTO streaming_links (movie_id, stream_url, quality_label) 
          VALUES ('$M_ID', '$S_URL', '$Q_LABEL');
          EOF
          
          echo "--------------------------------------------------"
          echo "‚úÖ ‡§¨‡§æ‡§¶‡§≤ ‡§≠‡§æ‡§à, ‡§Æ‡§ø‡§∂‡§® ‡§ï‡§æ‡§Æ‡§Ø‡§æ‡§¨! ü§™üòÇ"
          echo "‡§Æ‡•Ç‡§µ‡•Ä ID: $M_ID | ‡§ï‡•ç‡§µ‡§æ‡§≤‡§ø‡§ü‡•Ä: $Q_LABEL"
          echo "‡§≤‡§ø‡§Ç‡§ï: $S_URL"
          echo "--------------------------------------------------"
