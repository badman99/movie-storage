name: "Tabahi 3.0: Absolute Stealth HLS Engine ðŸŽ­ðŸš€"

on:
  workflow_dispatch:
    inputs:
      movie_url:
        description: 'Direct Movie Link'
        required: true
      movie_id:
        description: 'Target Movie ID (e.g. 42667)'
        required: true

jobs:
  stealth-hls-operation:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. à¤œà¤°à¥‚à¤°à¥€ à¤Ÿà¥‚à¤²à¥à¤¸ à¤¸à¥‡à¤Ÿà¤…à¤ª (FFmpeg + MySQL)
      - name: Install War Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg mysql-client
          echo "âœ… Tools Ready"

      # 2. à¤®à¥‚à¤µà¥€ à¤¡à¤¾à¤‰à¤¨à¤²à¥‹à¤¡ à¤•à¤°à¤¨à¤¾
      - name: Fetch Target Data
        run: |
          echo "â³ Downloading Movie..."
          curl -L "${{ github.event.inputs.movie_url }}" -o "raw_source.mp4"
          echo "âœ… Download Complete"

      # 3. ðŸ”¥ à¤µà¥€à¤¡à¤¿à¤¯à¥‹ à¤¹à¥‡à¤²à¥à¤¥ à¤šà¥‡à¤• (Verification)
      - name: Verify Health
        run: |
          echo "â³ Scanning for corruption..."
          if ! ffprobe -v error -show_format -show_streams "raw_source.mp4" ; then
            echo "ðŸš¨ Error: File Header Corrupt! Aborting."
            exit 1
          fi
          # Decoding test (First 5 seconds)
          ffmpeg -v error -i "raw_source.mp4" -t 5 -f null - || exit 1
          echo "âœ… Video is 100% Healthy!"

      # 4. ðŸ”¥ HLS TRANSCODING (360p & 240p Optimized + Original Audio)
      - name: Transcode to HLS
        run: |
          echo "â³ Processing 360p (Optimized Video | Original Audio)..."
          # -preset slow for best quality-size ratio | -c:a copy to keep audio original
          ffmpeg -i "raw_source.mp4" \
          -map 0:v:0 -map 0:a:0 -c:v libx264 -crf 28 -preset slow \
          -vf "scale=-2:360" -maxrate 600k -bufsize 1.2M \
          -c:a copy -sn -dn -map_metadata -1 \
          -f hls -hls_time 10 -hls_playlist_type vod \
          -hls_flags single_file -hls_segment_type fmp4 \
          -hls_segment_filename "v_360p.m4s" v_360p.m3u8

          echo "â³ Processing 240p (Optimized Video | Original Audio)..."
          ffmpeg -i "raw_source.mp4" \
          -map 0:v:0 -map 0:a:0 -c:v libx264 -crf 30 -preset slow \
          -vf "scale=-2:240" -maxrate 400k -bufsize 800k \
          -c:a copy -sn -dn -map_metadata -1 \
          -f hls -hls_time 10 -hls_playlist_type vod \
          -hls_flags single_file -hls_segment_type fmp4 \
          -hls_segment_filename "v_240p.m4s" v_240p.m3u8
          
          echo "âœ… Transcoding Finished!"

      # 5. ðŸŽ­ STEALTH MASKING (Renaming & internal link patching)
      # Sab .m4s aur .m3u8 ko .dat kar rahe hain taaki koi pehchan na paye
      - name: Apply Secret Mask
        id: mask
        run: |
          ID="${{ github.event.inputs.movie_id }}"
          
          # 1. Rename Data Files (.m4s) -> .dat
          mv "v_360p.m4s" "DATA_360p_${ID}.dat"
          mv "v_240p.m4s" "DATA_240p_${ID}.dat"
          
          # 2. Patch Playlist files to point to new .dat data files
          sed -i "s/v_360p.m4s/DATA_360p_${ID}.dat/g" v_360p.m3u8
          sed -i "s/v_240p.m4s/DATA_240p_${ID}.dat/g" v_240p.m3u8
          
          # 3. Rename Playlist Files (.m3u8) -> .dat
          mv "v_360p.m3u8" "LIST_360p_${ID}.dat"
          mv "v_240p.m3u8" "LIST_240p_${ID}.dat"
          
          # 4. Create Master Playlist (Isme sab masked links honge)
          echo "#EXTM3U" > master.m3u8
          echo "#EXT-X-VERSION:4" >> master.m3u8
          echo "#EXT-X-STREAM-INF:BANDWIDTH=800000,RESOLUTION=640x360" >> master.m3u8
          echo "LIST_360p_${ID}.dat" >> master.m3u8
          echo "#EXT-X-STREAM-INF:BANDWIDTH=400000,RESOLUTION=426x240" >> master.m3u8
          echo "LIST_240p_${ID}.dat" >> master.m3u8

          echo "f_360_list=LIST_360p_${ID}.dat" >> $GITHUB_OUTPUT
          echo "f_240_list=LIST_240p_${ID}.dat" >> $GITHUB_OUTPUT
          echo "f_360_data=DATA_360p_${ID}.dat" >> $GITHUB_OUTPUT
          echo "f_240_data=DATA_240p_${ID}.dat" >> $GITHUB_OUTPUT

      # 6. à¤—à¤¿à¤Ÿà¤¹à¤¬ à¤°à¤¿à¤²à¥€à¤œà¤¼ à¤ªà¤° à¤…à¤ªà¤²à¥‹à¤¡ à¤•à¤°à¤¨à¤¾
      - name: Deploy to Release
        id: release
        run: |
          TAG="REL_${{ github.event.inputs.movie_id }}_$(date +'%Y%m%d%H%M')"
          gh release create "$TAG" \
            --title "INTERNAL_DATA_ID_${{ github.event.inputs.movie_id }}" \
            "./master.m3u8" \
            "./${{ steps.mask.outputs.f_360_list }}" \
            "./${{ steps.mask.outputs.f_240_list }}" \
            "./${{ steps.mask.outputs.f_360_data }}" \
            "./${{ steps.mask.outputs.f_240_data }}"
          
          BASE="https://github.com/${{ github.repository }}/releases/download/$TAG"
          echo "u_master=$BASE/master.m3u8" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 7. ðŸš€ TiDB Sync (Hardcoded for Testing - Only Master Link)
      - name: Sync TiDB
        run: |
          DB_HOST="db.fr-pari1.bengt.wasmernet.com"
          DB_USER="c08b610b7a5780004be5223e9614"
          DB_PASS="0691c08b-610b-7bfa-8000-977f874d9bfb"
          DB_NAME="mcinema"
          MID="${{ github.event.inputs.movie_id }}"
          MASTER="${{ steps.release.outputs.u_master }}"
          
          mysql -h "$DB_HOST" -P 10272 -u "$DB_USER" -p"$DB_PASS" -D "$DB_NAME" <<EOF
          -- Table create if not exists (Only 3 columns needed now)
          CREATE TABLE IF NOT EXISTS hls_master_index (
              id INT AUTO_INCREMENT PRIMARY KEY,
              movie_id VARCHAR(50) UNIQUE,
              master_url TEXT,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );

          -- Insert or Update Master Link
          INSERT INTO hls_master_index (movie_id, master_url) 
          VALUES ('$MID', '$MASTER')
          ON DUPLICATE KEY UPDATE master_url = '$MASTER';
          EOF
          echo "âœ… à¤®à¤¿à¤¶à¤¨ à¤•à¤¾à¤®à¤¯à¤¾à¤¬! à¤®à¤¾à¤¸à¥à¤Ÿà¤° à¤²à¤¿à¤‚à¤• à¤¸à¥à¤Ÿà¥‹à¤° à¤¹à¥‹ à¤—à¤¯à¤¾ à¤¹à¥ˆà¥¤ ðŸš€ðŸ¤¡"
