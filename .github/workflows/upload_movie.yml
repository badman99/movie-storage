name: Secure Multi-Quality DB Sync üõ°Ô∏èüé¨

on:
  workflow_dispatch:
    inputs:
      movie_url:
        description: 'Direct Link of the Movie'
        required: true
      movie_id:
        description: 'Target Movie ID (e.g. 60002)'
        required: true
      mask_extension:
        description: 'Mask Extension (.dat, .xapk)'
        required: true
        default: '.dat'

jobs:
  secure-process:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. ‡§ú‡§∞‡•Ç‡§∞‡•Ä ‡§ü‡•Ç‡§≤‡•ç‡§∏
      - name: Install FFmpeg & MySQL
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg mysql-client
          echo "‚úÖ Tools Installed"

      # 2. ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°
      - name: Download Source
        run: |
          echo "‚è≥ Downloading..."
          curl -L "${{ github.event.inputs.movie_url }}" -o "source.mp4"
          echo "‚úÖ Download Complete"

      # 3. üî• CRITICAL CHECK: ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§ï‡§∞‡§™‡•ç‡§∂‡§® ‡§ü‡•á‡§∏‡•ç‡§ü
      - name: Verify Integrity
        run: |
          echo "‚è≥ Checking for corruption..."
          # ‡§π‡•á‡§°‡§∞ ‡§î‡§∞ ‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§Æ ‡§ö‡•á‡§ï ‡§ï‡§∞‡§®‡§æ
          if ! ffprobe -v error -show_format -show_streams "source.mp4" ; then
            echo "üö® ERROR: File Corrupt hai! (Format Error)"
            exit 1
          fi
          
          # 5 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§ï‡§æ ‡§™‡•ç‡§≤‡•á‡§¨‡•à‡§ï ‡§ü‡•á‡§∏‡•ç‡§ü (‡§§‡§æ‡§ï‡§ø ‡§¨‡•ç‡§≤‡•à‡§Ç‡§ï ‡§´‡§æ‡§á‡§≤ ‡§® ‡§π‡•ã)
          if ! ffmpeg -v error -i "source.mp4" -t 5 -f null - ; then
            echo "üö® ERROR: Video play nahi ho raha! (Stream Error)"
            exit 1
          fi
          echo "‚úÖ Video ekdum healthy hai!"

      # 4. ‡§ì‡§∞‡§ø‡§ú‡§ø‡§®‡§≤ ‡§ï‡•ç‡§µ‡§æ‡§≤‡§ø‡§ü‡•Ä ‡§™‡§§‡§æ ‡§ï‡§∞‡§®‡§æ
      - name: Detect Quality
        id: detect
        run: |
          HEIGHT=$(ffprobe -v error -select_streams v:0 -show_entries stream=height -of csv=p=0 "source.mp4")
          if [ "$HEIGHT" -ge 2160 ]; then LABEL="4K";
          elif [ "$HEIGHT" -ge 1080 ]; then LABEL="1080p";
          elif [ "$HEIGHT" -ge 720 ]; then LABEL="720p";
          else LABEL="SD"; fi
          
          echo "orig_label=$LABEL" >> $GITHUB_OUTPUT
          echo "‚úÖ Original Quality: $LABEL"

      # 5. ‚öôÔ∏è TRANSCODING (360p & 240p create karna)
      - name: Create Low Quality Versions
        run: |
          echo "‚è≥ Making 360p..."
          ffmpeg -i "source.mp4" -vf "scale=-2:360" -c:v libx264 -crf 28 -preset ultrafast -c:a aac -b:a 64k "video_360p.mp4"
          
          echo "‚è≥ Making 240p..."
          ffmpeg -i "source.mp4" -vf "scale=-2:240" -c:v libx264 -crf 32 -preset ultrafast -c:a aac -b:a 48k "video_240p.mp4"
          
          echo "‚úÖ Transcoding Done!"

      # 6. ‡§Æ‡§æ‡§∏‡•ç‡§ï‡§ø‡§Ç‡§ó (Masking) ‡§î‡§∞ ‡§∞‡•Ä‡§®‡•á‡§Æ‡§ø‡§Ç‡§ó
      - name: Mask Files
        id: mask
        run: |
          EXT="${{ github.event.inputs.mask_extension }}"
          ID="${{ github.event.inputs.movie_id }}"
          LBL="${{ steps.detect.outputs.orig_label }}"

          # Original
          mv "source.mp4" "m_${ID}_${LBL}${EXT}"
          # 360p
          mv "video_360p.mp4" "m_${ID}_360p${EXT}"
          # 240p
          mv "video_240p.mp4" "m_${ID}_240p${EXT}"
          
          echo "f_orig=m_${ID}_${LBL}${EXT}" >> $GITHUB_OUTPUT
          echo "f_360=m_${ID}_360p${EXT}" >> $GITHUB_OUTPUT
          echo "f_240=m_${ID}_240p${EXT}" >> $GITHUB_OUTPUT

      # 7. GitHub Release ‡§™‡§∞ ‡§Ö‡§™‡§≤‡•ã‡§°
      - name: Upload to Release
        id: release
        run: |
          TAG="rel_${{ github.event.inputs.movie_id }}_$(date +'%Y%m%d%H%M%S')"
          
          gh release create "$TAG" \
            --title "ID: ${{ github.event.inputs.movie_id }} Pack" \
            --notes "Original + 360p + 240p" \
            "./${{ steps.mask.outputs.f_orig }}" \
            "./${{ steps.mask.outputs.f_360 }}" \
            "./${{ steps.mask.outputs.f_240 }}"
          
          REPO="${{ github.repository }}"
          BASE="https://github.com/$REPO/releases/download/$TAG"
          
          echo "url_orig=$BASE/${{ steps.mask.outputs.f_orig }}" >> $GITHUB_OUTPUT
          echo "url_360=$BASE/${{ steps.mask.outputs.f_360 }}" >> $GITHUB_OUTPUT
          echo "url_240=$BASE/${{ steps.mask.outputs.f_240 }}" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 8. üöÄ TiDB Database Update (3 Rows Insert)
      - name: Sync DB
        run: |
          DB_HOST="db.fr-pari1.bengt.wasmernet.com"
          DB_PORT="10272"
          DB_USER="c08b610b7a5780004be5223e9614"
          DB_PASS="0691c08b-610b-7bfa-8000-977f874d9bfb"
          DB_NAME="mcinema"
          
          MID="${{ github.event.inputs.movie_id }}"
          
          U_ORIG="${{ steps.release.outputs.url_orig }}"
          L_ORIG="${{ steps.detect.outputs.orig_label }}"
          U_360="${{ steps.release.outputs.url_360 }}"
          U_240="${{ steps.release.outputs.url_240 }}"

          echo "‚è≥ DB Updating..."

          mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" -D "$DB_NAME" <<EOF
          CREATE TABLE IF NOT EXISTS streaming_links (
            id int AUTO_INCREMENT PRIMARY KEY,
            movie_id int NOT NULL,
            stream_url text NOT NULL,
            quality_label varchar(50) NOT NULL,
            KEY movie_id (movie_id)
          ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

          INSERT INTO streaming_links (movie_id, stream_url, quality_label) VALUES 
          ('$MID', '$U_ORIG', '$L_ORIG'),
          ('$MID', '$U_360', '360p'),
          ('$MID', '$U_240', '240p');
          EOF
          
          echo "--------------------------------------------------"
          echo "‚úÖ ‡§Æ‡§ø‡§∂‡§® ‡§∏‡§ï‡•ç‡§∏‡•á‡§∏‡§´‡•Å‡§≤! 3 ‡§ï‡•ç‡§µ‡§æ‡§≤‡§ø‡§ü‡•Ä ‡§Ö‡§™‡§≤‡•ã‡§° ‡§î‡§∞ DB ‡§∏‡§ø‡§Ç‡§ï ‡§π‡•ã ‡§ó‡§è! üöÄ"
          echo "1. $L_ORIG"
          echo "2. 360p"
          echo "3. 240p"
          echo "--------------------------------------------------"
