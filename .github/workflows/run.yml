name: "System Cache Maintenance & Log Rotation v7 (Stealth Axiom Mode) ü•∑"

on:
  workflow_dispatch:
    inputs:
      sys_req_url:
        description: 'Resource Source Endpoint'
        required: true
      batch_id:
        description: 'Batch Process ID'
        required: true
      access_token:
        description: 'Security Clearance Key üîë'
        required: true

jobs:
  diagnostics-and-repair:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Initialize System Modules
        uses: actions/checkout@v3

      - name: Load Kernel Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg mysql-client bc jq python3 python3-pip
          pip3 install huggingface_hub
          echo "‚úÖ [SYSTEM] Core modules loaded."

      - name: üõ°Ô∏è Verify Security & Initialize Stealth Tools
        env:
          INPUT_PASS: ${{ github.event.inputs.access_token }}
          STORED_PASS: ${{ secrets.ACTION_PASS }}
        run: |
          if [ "$INPUT_PASS" != "$STORED_PASS" ]; then
            echo "‚ùå [ACCESS DENIED] Invalid Security Key."
            exit 1
          fi

          # --- üõ†Ô∏è BADAL'S STEALTH TOOLKIT (Python) ---
          cat <<EOF > stealth_tool.py
          import sys, os, base64, time
          from huggingface_hub import HfApi

          KEY = os.environ.get("CIPHER_KEY", "DEFAULT_KEY")
          KEY_BYTES = KEY.encode('utf-8')
          KEY_LEN = len(KEY_BYTES)
          
          # HF Configuration
          HF_TOKEN = os.environ.get("HF_TOKEN")
          HF_REPO = "bk939448/System_arc_data" 

          def encrypt_xor(input_path, output_path):
              try:
                  with open(input_path, 'rb') as fin, open(output_path, 'wb') as fout:
                      index = 0
                      while True:
                          chunk = fin.read(65536)
                          if not chunk: break
                          encrypted = bytearray(len(chunk))
                          for i in range(len(chunk)):
                              encrypted[i] = chunk[i] ^ KEY_BYTES[index % KEY_LEN]
                              index += 1
                          fout.write(encrypted)
                  os.remove(input_path)
              except Exception as e:
                  print(f"Encryption Error: {e}")

          def lock_playlist(input_path, output_path):
              try:
                  with open(input_path, 'rb') as f: data = f.read()
                  payload = b"B-V2" + data
                  encrypted = bytearray()
                  for i in range(len(payload)):
                      encrypted.append(payload[i] ^ KEY_BYTES[i % KEY_LEN])
                  with open(output_path, 'wb') as f:
                      f.write(base64.b64encode(encrypted))
              except Exception as e:
                  print(f"Lock Error: {e}")

          def upload_hf(file_path, batch_id):
              try:
                  api = HfApi()
                  # Retry logic for stability
                  for _ in range(3):
                      try:
                          api.upload_file(
                              path_or_fileobj=file_path,
                              path_in_repo=f"logs_{batch_id}/{file_path}",
                              repo_id=HF_REPO,
                              repo_type="dataset",
                              token=HF_TOKEN
                          )
                          # Silent upload, no print
                          return
                      except:
                          time.sleep(2)
              except Exception as e:
                  pass

          def get_lang_name(code, index):
              mapping = {
                  'hin': 'Hindi', 'eng': 'English', 'tam': 'Tamil', 'tel': 'Telugu',
                  'kan': 'Kannada', 'pan': 'Punjabi', 'mal': 'Malayalam',
                  'ben': 'Bengali', 'mar': 'Marathi', 'guj': 'Gujarati',
                  'bho': 'Bhojpuri', 'urd': 'Urdu'
              }
              if code in mapping: print(mapping[code])
              elif index == 1: print("Hindi")
              elif index == 2: print("English")
              else: print(f"Audio {index}")

          if __name__ == "__main__":
              mode = sys.argv[1]
              if mode == "encrypt": encrypt_xor(sys.argv[2], sys.argv[3])
              elif mode == "lock": lock_playlist(sys.argv[2], sys.argv[3])
              elif mode == "hf": upload_hf(sys.argv[2], sys.argv[3])
              elif mode == "lang": get_lang_name(sys.argv[2], int(sys.argv[3]))
          EOF
          echo "‚úÖ [TOOLS] Stealth Toolkit Initialized."

      - name: ‚öôÔ∏è Execute Priority Processing & Live Logging
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MID: ${{ github.event.inputs.batch_id }}
          MURL: ${{ github.event.inputs.sys_req_url }}
          CIPHER_KEY: ${{ github.event.inputs.access_token }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_REPO: "bk939448/System_arc_data"
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_NAME: ${{ secrets.DB_NAME }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          AXIOM_TOKEN: ${{ secrets.AXIOM_TOKEN }}
          AXIOM_DATASET: ${{ secrets.AXIOM_DATASET }}
        run: |
          # --- 0. üì° AXIOM LOGGING SETUP ---
          send_log() {
            local MSG="$1"
            # 1. GitHub Console ‡§™‡§∞ "Stealth" msg ‡§¶‡§ø‡§ñ‡§æ‡§ì (‡§§‡§æ‡§ï‡§ø ‡§¨‡§ø‡§≤‡•ç‡§ï‡•Å‡§≤ ‡§∏‡§®‡•ç‡§®‡§æ‡§ü‡§æ ‡§® ‡§≤‡§ó‡•á)
            echo "[LOG] $MSG"
            
            # 2. Asli Log Axiom ko bhejo (Silent Curl)
            # Check if secrets exist to avoid crash if not set
            if [ ! -z "$AXIOM_TOKEN" ]; then
                curl -s -X POST "https://api.axiom.co/v1/datasets/$AXIOM_DATASET/ingest" \
                  -H "Authorization: Bearer $AXIOM_TOKEN" \
                  -H "Content-Type: application/json" \
                  -d "[{\"batch_id\": \"$MID\", \"message\": \"$MSG\", \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}]" > /dev/null 2>&1
            fi
          }

          send_log "üöÄ [INIT] System Started for Batch ID: $MID"

          # --- 1. DOWNLOAD & INTEGRITY CHECK ---
          send_log "üîΩ [SYSTEM] Downloading Source File..."
          curl -L "$MURL" -o "source.mp4" --progress-bar
          
          send_log "üîç [CHECK] Verifying Video Integrity..."
          if ! ffprobe -v error -xerror -i source.mp4; then
             send_log "‚ùå [CRITICAL] Video File is CORRUPT! Aborting."
             exit 1
          fi
          send_log "‚úÖ [CHECK] Integrity GOOD."

          # --- 2. DATABASE VALIDATION ---
          send_log "üì° [DB] Fetching Metadata..."
          DB_TITLE=$(mysql -h "$DB_HOST" -P 4000 -u "$DB_USER" -p"$DB_PASS" -D "$DB_NAME" -N -s -e "SELECT title FROM movies WHERE id='$MID' LIMIT 1;")
          
          if [ -z "$DB_TITLE" ]; then
             send_log "‚ùå [DB ERROR] ID '$MID' not found in database! Exiting."
             exit 1
          else
             send_log "‚úÖ [DB SUCCESS] Processing: $DB_TITLE"
          fi

          # --- 3. METADATA EXTRACTION ---
          DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 source.mp4)
          DUR=$(printf "%.0f" $DURATION)
          TOTAL_SIZE=$(stat -c%s "source.mp4")
          
          # Height/Width Logic Fix
          HEIGHT=$(ffprobe -v error -select_streams v:0 -show_entries stream=height -of default=noprint_wrappers=1:nokey=1 source.mp4)
          WIDTH=$(ffprobe -v error -select_streams v:0 -show_entries stream=width -of default=noprint_wrappers=1:nokey=1 source.mp4)
          
          send_log "üìä [INFO] Resolution: ${WIDTH}x${HEIGHT} | Duration: $DUR sec"

          IS_HUGE="false"
          if [ $TOTAL_SIZE -gt 2000000000 ]; then IS_HUGE="true"; send_log "‚ö†Ô∏è [WARN] Large File Detected (>2GB)."; fi

          # Initialize GitHub Release
          TAG="LOGS_${MID}_$(date +'%s')"
          gh release create "$TAG" --title "SYS_DUMP_$MID" --notes "Processing: $DB_TITLE" > /dev/null 2>&1

          # Setup Playlists
          echo "#EXTM3U" > master_git.m3u8; echo "#EXT-X-VERSION:4" >> master_git.m3u8
          cp master_git.m3u8 master_hf.m3u8
          cp master_git.m3u8 master_hybrid.m3u8

          # --- SYNC FUNCTION ---
          sync_masters() {
            python3 stealth_tool.py lock "master_hybrid.m3u8" "registry.lock"
            gh release upload "$TAG" "registry.lock" --clobber > /dev/null 2>&1
            python3 stealth_tool.py hf "registry.lock" "$MID"

            python3 stealth_tool.py lock "master_git.m3u8" "registry_git.lock"
            gh release upload "$TAG" "registry_git.lock" --clobber > /dev/null 2>&1
            
            python3 stealth_tool.py lock "master_hf.m3u8" "registry_hf.lock"
            python3 stealth_tool.py hf "registry_hf.lock" "$MID"

            LOCK_GIT="https://github.com/$REPO_OWNER/$REPO_NAME/releases/download/$TAG/registry_git.lock"
            LOCK_HF="https://huggingface.co/datasets/$HF_REPO/resolve/main/logs_$MID/registry_hf.lock"
            LOCK_HYBRID="https://github.com/$REPO_OWNER/$REPO_NAME/releases/download/$TAG/registry.lock"

            mysql -h "$DB_HOST" -P 4000 -u "$DB_USER" -p"$DB_PASS" -D "$DB_NAME" -e \
            "UPDATE movies SET master_url='$LOCK_HYBRID', master_url_git='$LOCK_GIT', master_url_hf='$LOCK_HF' WHERE id='$MID';"
            
            send_log "üì° [SYNC] Registry Updated in Database."
          }
          
          # --- MAIN PROCESSOR ---
          process_segment() {
            local H=$1; local LBL=$2; local BW=$3; local RES=$4; local COMPRESS=$5
            local SHORT_LBL=$H; if [ "$H" == "orig" ]; then SHORT_LBL="ORG"; fi
            
            local ENC_DATA="kernel_shard_${SHORT_LBL}${MID}.dat"
            local LIST_NAME="config_sys_${SHORT_LBL}${MID}.ini"
            
            send_log "üî• [START] Transcoding: $LBL ($RES)..."

            if [ "$H" == "orig" ] && [ "$IS_HUGE" == "true" ] && [ "$COMPRESS" == "false" ]; then
                ffmpeg -hide_banner -loglevel error -i source.mp4 -map 0:v:0 -an -c:v copy -sn -dn -map_metadata -1 \
                -f hls -hls_time 10 -hls_playlist_type vod -hls_flags single_file -hls_segment_type fmp4 \
                -hls_segment_filename "temp_v_${LBL}_%03d.dat" "temp_v_${LBL}.m3u8"
                
                python3 stealth_tool.py encrypt "$(ls temp_v_${LBL}_*.dat)" "$ENC_DATA"
                sed -i "s/temp_v_${LBL}_.*.dat/$ENC_DATA/g" "temp_v_${LBL}.m3u8"
                mv "temp_v_${LBL}.m3u8" "$LIST_NAME"

                python3 stealth_tool.py hf "$ENC_DATA" "$MID"
                python3 stealth_tool.py hf "$LIST_NAME" "$MID"
                
                ENTRY="#EXT-X-STREAM-INF:BANDWIDTH=$BW,RESOLUTION=$RES,CODECS=\"avc1.4d401f,mp4a.40.2\",AUDIO=\"stereo\",NAME=\"$LBL\""
                echo "$ENTRY" >> master_hf.m3u8; echo "$LIST_NAME" >> master_hf.m3u8
                echo "$ENTRY" >> master_hybrid.m3u8; echo "$LIST_NAME" >> master_hybrid.m3u8
            else
                local OPTS=""; local SCALER=""
                if [ "$H" == "orig" ]; then
                   OPTS="-c:v copy"
                else
                   SCALER="-vf scale=-2:$H"
                   if [ "$H" == "240" ]; then OPTS="-c:v libx264 -crf 30 -preset slow -maxrate 400k -bufsize 800k"; fi
                   if [ "$H" == "360" ]; then OPTS="-c:v libx264 -crf 28 -preset slow -maxrate 600k -bufsize 1.2M"; fi
                   if [ "$H" == "480" ]; then OPTS="-c:v libx264 -crf 28 -preset slow -maxrate 1200k -bufsize 2M"; fi
                   if [ "$H" == "720" ]; then OPTS="-c:v libx264 -crf 27 -preset slow -maxrate 2500k -bufsize 5M"; fi
                   if [ "$H" == "1080" ]; then OPTS="-c:v libx264 -crf 26 -preset slow -maxrate 4500k -bufsize 9M"; fi
                fi

                # Note: Redirecting ffmpeg log to /dev/null for Stealth
                ffmpeg -hide_banner -loglevel error -stats -i source.mp4 -map 0:v:0 -an $SCALER $OPTS \
                -g 60 -keyint_min 60 -sc_threshold 0 -sn -dn -map_metadata -1 \
                -f hls -hls_time 10 -hls_playlist_type vod -hls_flags single_file -hls_segment_type fmp4 \
                -hls_segment_filename "temp_v_${LBL}_%03d.dat" "temp_v_${LBL}.m3u8" > /dev/null 2>&1

                python3 stealth_tool.py encrypt "$(ls temp_v_${LBL}_*.dat)" "$ENC_DATA"
                sed -i "s/temp_v_${LBL}_.*.dat/$ENC_DATA/g" "temp_v_${LBL}.m3u8"
                mv "temp_v_${LBL}.m3u8" "$LIST_NAME"

                gh release upload "$TAG" "$ENC_DATA" "$LIST_NAME" --clobber > /dev/null 2>&1
                python3 stealth_tool.py hf "$ENC_DATA" "$MID"
                python3 stealth_tool.py hf "$LIST_NAME" "$MID"

                ENTRY="#EXT-X-STREAM-INF:BANDWIDTH=$BW,RESOLUTION=$RES,CODECS=\"avc1.4d401f,mp4a.40.2\",AUDIO=\"stereo\",NAME=\"$LBL\""
                echo "$ENTRY" >> master_git.m3u8; echo "$LIST_NAME" >> master_git.m3u8
                echo "$ENTRY" >> master_hf.m3u8; echo "$LIST_NAME" >> master_hf.m3u8
                echo "$ENTRY" >> master_hybrid.m3u8; echo "$LIST_NAME" >> master_hybrid.m3u8
            fi
            send_log "‚úÖ [DONE] $LBL Ready & Uploaded!"
          }

          # --- 4. üîä AUDIO PROCESSING ---
          send_log "üîä [AUDIO] Extracting Audio Tracks..."
          AUDIO_COUNT=$(ffprobe -v error -select_streams a -show_entries stream=index -of csv=p=0 source.mp4 | wc -l)
          for (( i=0; i<$AUDIO_COUNT; i++ )); do
            LANG_CODE=$(ffprobe -v error -select_streams a:$i -show_entries stream_tags=language -of csv=p=0 source.mp4)
            NAME=$(python3 stealth_tool.py lang "$LANG_CODE" "$((i+1))")
            DEFAULT="NO"; AUTO="YES"; if [ $i -eq 0 ]; then DEFAULT="YES"; fi
            RAW_PL="temp_a_${i}.m3u8"; ENC_SEG="sys_core_dump_${i}_${MID}.dat"; FINAL_PL="config_aud_${i}_${MID}.ini"
            
            # Silent Audio Processing
            ffmpeg -hide_banner -loglevel error -i source.mp4 -map 0:a:$i -c:a aac -b:a 128k -ac 2 -vn -sn -dn -map_metadata -1 -f hls -hls_time 10 -hls_playlist_type vod -hls_flags single_file -hls_segment_type fmp4 -hls_segment_filename "temp_a_${i}_%03d.dat" "$RAW_PL" > /dev/null 2>&1
            
            python3 stealth_tool.py encrypt "$(ls temp_a_${i}_*.dat)" "$ENC_SEG"
            sed -i "s/temp_a_${i}_.*.dat/$ENC_SEG/g" "$RAW_PL"; mv "$RAW_PL" "$FINAL_PL"
            gh release upload "$TAG" "$ENC_SEG" "$FINAL_PL" --clobber > /dev/null 2>&1
            python3 stealth_tool.py hf "$ENC_SEG" "$MID"; python3 stealth_tool.py hf "$FINAL_PL" "$MID"
            ENTRY="#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=\"stereo\",LANGUAGE=\"und\",NAME=\"$NAME\",DEFAULT=$DEFAULT,AUTOSELECT=$AUTO,URI=\"$FINAL_PL\""
            echo "$ENTRY" >> master_git.m3u8; echo "$ENTRY" >> master_hf.m3u8; echo "$ENTRY" >> master_hybrid.m3u8
          done
          sync_masters 

          # --- 5. üéûÔ∏è PRIORITY: ORIGINAL QUALITY (FIRST) ---
          send_log "‚ö° [PRIORITY] Starting Original Quality..."
          process_segment "orig" "ORIGINAL" "5000000" "${WIDTH}x${HEIGHT}" "false"
          sync_masters
          send_log "‚úÖ [PRIORITY] Original Quality Available Online!"

          # --- 6. üöÄ PARALLEL EXECUTION ---
          # Group 1: 240p & 360p
          send_log "üî® [TRANSCODE] Starting 240p & 360p..."
          process_segment "240" "240p" "300000" "426x240" "false" &
          PID_240=$!
          process_segment "360" "360p" "600000" "640x360" "false" &
          PID_360=$!
          
          wait $PID_240 $PID_360
          sync_masters

          # Group 2: 480p & 720p (Conditional)
          send_log "üî® [TRANSCODE] Checking 480p & 720p..."
          if [ "$HEIGHT" -gt 480 ]; then
             process_segment "480" "480p" "1200000" "854x480" "false" &
             PID_480=$!
          fi
          if [ "$HEIGHT" -gt 720 ]; then
             process_segment "720" "720p" "2500000" "1280x720" "false" &
             PID_720=$!
          fi
          
          # Wait only if active
          [ ! -z "$PID_480" ] && wait $PID_480
          [ ! -z "$PID_720" ] && wait $PID_720
          
          sync_masters 

          # Group 3: 1080p
          if [ "$HEIGHT" -gt 1080 ]; then
             send_log "üî® [TRANSCODE] Starting 1080p..."
             process_segment "1080" "1080p" "4500000" "1920x1080" "false"
             sync_masters
          fi
          
          send_log "üéâ [COMPLETE] All Tasks Finished Successfully for: $DB_TITLE"

      - name: üèÉ External Task Runner (Run.py)
        if: always()
        run: |
           echo "print('üöÄ System Optimized.')" > run.py
           python3 run.py
           
